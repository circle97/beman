<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.beman.mapper.UserFollowMapper">

    <!-- 用户关注结果映射 -->
    <resultMap id="UserFollowVOMap" type="com.beman.model.vo.UserFollowVO">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="username" property="username"/>
        <result column="nickname" property="nickname"/>
        <result column="avatar" property="avatar"/>
        <result column="follow_type" property="followType"/>
        <result column="remark_name" property="remarkName"/>
        <result column="create_time" property="createTime"/>
        <result column="user_status" property="userStatus"/>
        <result column="last_active_time" property="lastActiveTime"/>
    </resultMap>

    <!-- 分页查询关注列表 -->
    <select id="selectFollowingPage" resultMap="UserFollowVOMap">
        SELECT 
            uf.id,
            u.id as user_id,
            u.username,
            u.nickname,
            u.avatar,
            uf.follow_type,
            uf.remark_name,
            uf.create_time,
            u.status as user_status,
            u.last_login_time as last_active_time
        FROM user_follow uf
        LEFT JOIN user u ON uf.following_id = u.id
        WHERE uf.follower_id = #{userId}
        AND uf.status = 0
        AND uf.deleted = 0
        AND u.deleted = 0
        <if test="followType != null">
            AND uf.follow_type = #{followType}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                u.username LIKE CONCAT('%', #{keyword}, '%')
                OR u.nickname LIKE CONCAT('%', #{keyword}, '%')
                OR uf.remark_name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY uf.create_time DESC
    </select>

    <!-- 分页查询粉丝列表 -->
    <select id="selectFollowersPage" resultMap="UserFollowVOMap">
        SELECT 
            uf.id,
            u.id as user_id,
            u.username,
            u.nickname,
            u.avatar,
            uf.follow_type,
            uf.remark_name,
            uf.create_time,
            u.status as user_status,
            u.last_login_time as last_active_time
        FROM user_follow uf
        LEFT JOIN user u ON uf.follower_id = u.id
        WHERE uf.following_id = #{userId}
        AND uf.status = 0
        AND uf.deleted = 0
        AND u.deleted = 0
        <if test="followType != null">
            AND uf.follow_type = #{followType}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                u.username LIKE CONCAT('%', #{keyword}, '%')
                OR u.nickname LIKE CONCAT('%', #{keyword}, '%')
                OR uf.remark_name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY uf.create_time DESC
    </select>

    <!-- 查询用户是否已关注 -->
    <select id="selectIsFollowing" resultType="java.lang.Boolean">
        SELECT COUNT(*) > 0
        FROM user_follow
        WHERE follower_id = #{followerId}
        AND following_id = #{followingId}
        AND status = 0
        AND deleted = 0
    </select>

    <!-- 查询关注关系 -->
    <select id="selectFollowRelation" resultType="com.beman.model.UserFollow">
        SELECT *
        FROM user_follow
        WHERE follower_id = #{followerId}
        AND following_id = #{followingId}
        AND deleted = 0
        LIMIT 1
    </select>

    <!-- 查询关注数量 -->
    <select id="selectFollowingCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM user_follow
        WHERE follower_id = #{userId}
        AND status = 0
        AND deleted = 0
    </select>

    <!-- 查询粉丝数量 -->
    <select id="selectFollowersCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM user_follow
        WHERE following_id = #{userId}
        AND status = 0
        AND deleted = 0
    </select>

    <!-- 查询互相关注的用户ID列表 -->
    <select id="selectMutualFollowUserIds" resultType="java.lang.Long">
        SELECT DISTINCT uf1.follower_id
        FROM user_follow uf1
        INNER JOIN user_follow uf2 ON uf1.follower_id = uf2.following_id 
            AND uf1.following_id = uf2.follower_id
        WHERE uf1.following_id = #{userId}
        AND uf1.status = 0
        AND uf2.status = 0
        AND uf1.deleted = 0
        AND uf2.deleted = 0
    </select>

</mapper>
